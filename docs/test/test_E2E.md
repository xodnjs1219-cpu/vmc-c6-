## E2E 테스트 구현 계획 (TDD 기반)

### 1. 개요

-   **목적 및 범위:** 본 문서는 월 구독제 AI 사주 풀이 서비스 MVP의 안정적인 출시를 위해, Playwright를 활용한 E2E(End-to-End) 테스트 구현 계획을 정의합니다. 이 계획은 **Outside-In TDD (Test-Driven Development)** 접근법을 채택하여, 실제 사용자 시나리오를 검증하는 인수 테스트(E2E) 작성을 통해 전체 기능 개발을 주도하는 것을 목표로 합니다.
-   **접근 방식:** 모든 기능 개발은 실패하는 E2E 테스트 케이스를 먼저 작성하는 것(Red)으로 시작합니다. 이후 테스트를 통과시키는 최소한의 코드(Green)를 작성하고, 마지막으로 내부 구조를 개선(Refactor)하는 사이클을 따릅니다. 이 방식은 항상 동작하는 소프트웨어를 유지하며 신속한 반복 개발을 가능하게 합니다.

### 2. 테스트 범위

#### 테스트 포함 범위
-   **신규 사용자 온보딩:** Clerk 웹훅을 통한 사용자 가입 시 DB에 `users` 및 `subscriptions` 레코드(Free 플랜, 3회)가 정상적으로 생성되는 과정
-   **무료 사용자 핵심 여정:**
    -   남은 횟수가 있는 무료 사용자의 사주 분석 성공 플로우
    -   분석 횟수(Quota)를 모두 소진 시 분석이 차단되고 구독 페이지로 유도되는 시나리오
-   **Pro 구독 전환 및 해지:**
    -   무료 사용자가 Pro 플랜으로 업그레이드하는 과정 (토스페이먼츠 연동 모킹)
    -   Pro 사용자가 구독 해지를 예약하고, 다음 결제일까지 서비스가 유지되는 시나리오
-   **핵심 백엔드 로직 (API 직접 호출):**
    -   Supabase Cron Job을 통해 정기 결제가 성공/실패하는 시나리오
    -   예약된 구독 해지가 정상 처리되는 시나리오
-   **분석 결과 조회:** 대시보드에서 과거 분석 목록을 확인하고, 상세 페이지로 이동하는 기능

#### 테스트 제외 범위
-   **세분화된 외부 서비스 실패 케이스:** 토스페이먼츠의 구체적인 결제 실패 사유(한도 초과, 분실 카드 등)는 '결제 실패'라는 단일 케이스로 통합하여 테스트합니다.
-   **비주얼/UI 완전성:** 브라우저/디바이스별 픽셀-퍼펙트한 UI 검증은 제외합니다. 대신, 주요 페이지의 레이아웃 일관성을 보장하기 위해 **비주얼 스냅샷 테스트**를 활용합니다.
-   **성능 및 부하 테스트:** MVP 단계에서는 기능의 정상 동작 여부에 집중합니다.
-   **외부 서비스 UI:** Clerk 로그인/회원가입 UI, 토스페이먼츠 결제창 UI 자체는 테스트 범위에서 제외합니다.

### 3. 테스트 전략

-   **TDD 워크플로우:**
    1.  **RED:** `*.spec.ts` 파일에 Playwright를 사용하여 검증하고자 하는 사용자 시나리오에 대한 테스트 케이스를 작성합니다.
    2.  `npx playwright test` 명령으로 테스트를 실행하여 의도대로 실패하는지 확인합니다.
    3.  **GREEN:** 테스트를 통과시키기 위한 최소한의 프론트엔드 UI, API 라우트, 백엔드 서비스 로직을 구현합니다.
    4.  테스트를 재실행하여 통과를 확인합니다.
    5.  **REFACTOR:** 테스트가 계속 통과하는 상태를 유지하며 코드의 가독성, 중복 제거 등 내부 구조를 개선합니다.
    6.  통과된 테스트와 구현 코드를 하나의 원자적 단위로 커밋합니다.

-   **테스트 환경:**
    -   **도구:** Playwright를 E2E 테스트 프레임워크로, Vitest를 복잡한 비즈니스 로직의 단위/통합 테스트용으로 사용합니다.
    -   **실행 환경:** `.github/workflows/playwright.yml`에 명시된 바와 같이, 모든 테스트는 별도의 임시 테스트 데이터베이스에 연결된 로컬 개발 서버를 대상으로 실행됩니다. `supabase db reset`을 통해 매 실행마다 환경을 초기화하여 테스트의 반복성을 보장합니다.
    -   **CI 연동:** 모든 Pull Request는 Github Actions에서 전체 E2E 테스트를 통과해야만 Main 브랜치에 병합될 수 있도록 Branch Protection Rule을 설정합니다.

-   **데이터 관리:**
    -   **테스트 데이터 팩토리:** `tests/utils/db.ts`에 `createTestUser({ plan: 'Pro', remaining_tries: 1, next_payment_date: 'today' })`와 같이 시나리오에 맞는 데이터를 선언적으로 생성하는 팩토리 함수를 구현하여 테스트 준비 단계를 간소화합니다.
    -   **데이터 격리:** 각 테스트 스위트의 `beforeEach` / `afterEach` 훅에서 테스트 데이터를 생성하고 `cleanupUser` 헬퍼를 통해 완벽히 제거하여 테스트 간 독립성을 확보합니다.
    -   **인증 추상화:** Playwright의 **커스텀 Fixture**(`loggedInPage`)를 생성합니다. 이 Fixture는 테스트 유저를 DB에 생성하고, 인증 세션 쿠키를 브라우저에 주입하는 과정을 자동화하여, 모든 테스트가 '로그인된 상태'에서 시작할 수 있도록 합니다.
    -   **외부 서비스 모킹:** `page.route()`를 사용하여 **Clerk(웹훅), Google Gemini, 토스페이먼츠**의 모든 외부 네트워크 호출을 모킹합니다. 이를 통해 비용을 절감하고, 빠르고 예측 가능한 테스트 환경을 구축합니다.

### 4. 주요 테스트 케이스

-   **Test Case 1: 신규 사용자 가입 및 온보딩 (`auth.spec.ts`)**
    -   **시나리오:** Clerk의 `user.created` 웹훅 이벤트를 시뮬레이션하는 API 요청을 백엔드 엔드포인트(`api/webhooks/clerk`)로 직접 전송한다.
    -   **기대 결과:** 요청 처리 후, 데이터베이스의 `users` 테이블에 해당 사용자 정보가, `subscriptions` 테이블에는 `plan_type: 'Free'`, `remaining_tries: 3`인 레코드가 생성된다.
    -   **전제 조건:** 없음.

-   **Test Case 2: 무료 사용자의 마지막 분석 시도 및 구독 유도 (`free-user.spec.ts`)**
    -   **시나리오:** 남은 횟수가 1회인 무료 사용자로 로그인한다. '/new-analysis' 페이지에서 사주 분석을 1회 성공적으로 수행한다. 이후 다시 분석을 시도한다.
    -   **기대 결과:** 첫 분석은 성공하고 DB의 `remaining_tries`는 0으로 감소한다. 두 번째 분석 시도 시, API는 'QUOTA_EXCEEDED' 에러를 반환하며 사용자는 '/subscription' 페이지로 리디렉션된다.
    -   **전제 조건:** `createTestUser({ plan: 'Free', remaining_tries: 1 })` 팩토리 함수.

-   **Test Case 3: Pro 구독 업그레이드 (`subscription.spec.ts`)**
    -   **시나리오:** 무료 사용자로 로그인하여 '/subscription' 페이지로 이동, 'Pro 구독하기' 버튼을 클릭한다. 토스페이먼츠 결제창 연동 및 성공 콜백 과정을 모킹한다.
    -   **기대 결과:** 사용자의 `subscriptions` 레코드가 `plan_type: 'Pro'`, `remaining_tries: 10`으로 업데이트되고, `billing_key`와 한 달 뒤의 `next_payment_date`가 설정된다.
    -   **전제 조건:** `createTestUser({ plan: 'Free' })` 팩토리 함수, 성공적인 토스페이먼츠 API 응답 모킹.

-   **Test Case 4: 정기 결제 실패 및 등급 강등 (`cron.spec.ts`)**
    -   **시나리오:** 결제일이 오늘인 Pro 사용자를 DB에 생성한다. 토스페이먼츠의 `chargeBilling` API가 '실패'를 반환하도록 모킹한다. `/api/cron/process-subscriptions` 엔드포인트를 직접 호출한다.
    -   **기대 결과:** 해당 사용자의 `subscriptions` 레코드가 `plan_type: 'Free'`로 변경되고, `billing_key`가 삭제되며, `remaining_tries`가 0으로 설정된다.
    -   **전제 조건:** `createTestUser({ plan: 'Pro', next_payment_date: 'today' })` 팩토리 함수, 실패하는 토스페이먼츠 API 응답 모킹.

### 5. 테스트 커버리지 목표 (70% 이상)

-   **측정 방법:** Vitest에 내장된 `istanbul`을 사용하여 백엔드 및 핵심 프론트엔드 로직에 대한 코드 커버리지를 측정합니다. 라인 및 브랜치 커버리지를 주요 지표로 삼습니다.
-   **목표 달성 전략:**
    1.  **E2E로 넓게 커버:** 상기된 핵심 사용자 여정 기반의 E2E 테스트는 자연스럽게 프론트엔드-백엔드-DB를 아우르는 넓은 코드 범위를 실행시키므로 커버리지의 기반이 됩니다.
    2.  **통합/단위 테스트로 깊게 보완:** `create-service.ts`의 횟수 차감 트랜잭션, `service.ts`의 정기 결제 로직 등 복잡하고 중요한 비즈니스 로직은 Vitest를 사용한 단위/통합 테스트로 엣지 케이스까지 상세히 검증합니다.
    3.  **비주얼 스냅샷:** `분석 상세보기`, `대시보드` 등 주요 UI 페이지에 대해 Playwright 스냅샷 테스트를 적용하여 시각적 회귀를 방지하고 UI 코드의 신뢰도를 높입니다.

### 6. 일정 및 리소스

-   **예상 일정 (4주):**
    -   **1주차:** 테스트 환경 고도화 (DB 팩토리, 인증 Fixture 구현) 및 테스트 스위트 1 (인증/온보딩) 완료
    -   **2주차:** 테스트 스위트 2 (무료 사용자 여정) 완료
    -   **3주차:** 테스트 스위트 3 (Pro 구독 여정) 완료
    -   **4주차:** 테스트 스위트 4 (백엔드 Cron) 완료 및 전체 테스트 스위트 안정화, CI 연동 최종 점검
-   **리소스 및 역할:**
    -   **CTO (리드):** 테스트 계획 수립, 핵심 테스트 케이스 및 기능 구현, CI/CD 파이프라인 관리

### 7. 리스크 및 완화 방안

-   **리스크 1: 테스트 환경의 불안정성**
    -   **완화 방안:** 모든 테스트는 격리된 Docker 환경 또는 CI에서 제공하는 `supabase/setup-cli`를 통해 실행합니다. 각 테스트 실행 전 DB를 초기화하는 스크립트를 통해 일관된 환경을 보장합니다.
-   **리스크 2: MVP 요구사항의 빈번한 변경**
    -   **완화 방안:** TDD 접근법 자체가 요구사항 변경에 유연하게 대응할 수 있도록 돕습니다. 테스트를 구현 세부사항이 아닌 사용자 '행위'에 집중하여 작성함으로써, 내부 로직이 변경되어도 테스트는 깨지지 않도록 유지하여 리팩토링 비용을 줄입니다.
-   **리스크 3: 외부 서비스 모킹의 복잡성**
    -   **완화 방안:** 초기에는 성공/실패 등 단순한 케이스만 모킹합니다. 반복되는 모킹 로직은 `mockSuccessfulTossPayment(page)`와 같은 헬퍼 함수로 추상화하여 테스트 코드의 가독성과 재사용성을 높입니다.