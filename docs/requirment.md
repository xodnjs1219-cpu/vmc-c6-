# Requirements: 월 구독제 사주 풀이 웹서비스

## 개요:
Clerk (인증), Supabase (DB), 토스페이먼츠 (결제), Gemini (AI 사주 풀이)를 연동하여 월 구독 기반의 AI 사주 풀이 서비스를 제공하는 웹 애플리케이션.

## 페이지 구성:
* **홈 (랜딩 페이지)**: 서비스 설명, 요금제 안내, '새 분석하기', '대시보드', '구독 관리'로 이동 버튼 제공. (인증 전/후 상이)
* **대시보드 (분석 목록)**: 과거 사주 분석 내역 목록 표시. '새 분석하기', '구독 관리'로 이동 버튼 제공.
* **새 분석하기**: 사주 정보를 입력하고 Gemini를 통해 분석을 요청하는 페이지.
* **분석 상세보기**: 특정 사주 분석의 상세 내용과 MD 파일 다운로드 기능 제공.
* **구독 관리**: 현재 구독 상태 (요금제, 구독일, 남은 횟수) 표시 및 구독/해지 기능 제공.
* **인증 페이지**: Clerk SDK가 기본 제공하는 로그인, 회원가입 등의 페이지를 사용.

## 데이터 (Supabase):
* **사용자 정보**: Clerk을 통해 인증되며 Supabase 유저 정보와 연동.
* **구독 정보**: 사용자 ID, 현재 요금제(Free/Pro), 구독 시작일, 다음 결제일, 월별 남은 분석 횟수, 토스페이먼츠 빌링키.
* **분석 내역**: 사용자 ID, 입력된 사주 정보(이름, 생년월일시, 양/음력), Gemini 분석 결과(요약, 상세), 생성 일시.

## 기능:

### 공통 / 인증 (Clerk)
* 홈페이지(랜딩)를 제외한 모든 페이지는 Clerk 인증이 필요합니다. (인증 안 된 사용자는 인증 페이지로 리디렉션)
* Clerk SDK에서 기본 제공하는 인증 페이지(로그인, 회원가입 등)를 사용합니다.
* Clerk Webhook을 사용하여 Supabase의 사용자 및 구독 데이터를 동기화합니다. (Webhook은 배포 환경에서만 작동)

### 요금제 및 접근 제어
* **Free 요금제**:
    * 가격: 0원
    * 모델: Gemini 2.5 Flash
    * 제한: 가입 후 최초 3회만 '새 분석하기' 사용 가능.
* **Pro 요금제**:
    * 가격: 월 3,900원
    * 모델: Gemini 2.5 Pro 또는 Flash (사용자 선택 가능)
    * 제한: 월 10회 '새 분석하기' 사용 가능.
* Free 요금제 사용자가 3회 소진 후 '새 분석하기' 시도 시, '구독 관리' 페이지로 리디렉션됩니다.

### 홈 (랜딩 페이지)
* 서비스의 주요 기능과 설명을 표시합니다.
* Free/Pro 요금제에 대한 상세 설명을 표시합니다.
* 인증 전: '로그인/회원가입', '구독하기'(Pro) 버튼 표시.
* 인증 후: '새 분석하기', '대시보드', '구독 관리' 버튼 표시.

### 새 분석하기
* '홈'과 '대시보드' 페이지에서 이 페이지로 접근할 수 있습니다.
* 입력 필드:
    * 이름
    * 태어난 년/월/일/시
    * 양력/음력 선택
    * 태어난 시 '모름' 체크박스 (체크 시 시간 입력 비활성화)
* '분석하기' 버튼 클릭 시:
    1.  사용자의 현재 요금제와 남은 횟수를 확인합니다. (횟수 소진 시 '구독 관리'로 이동)
    2.  선택된 요금제에 맞는 Gemini 모델(Flash/Pro)로 사주 풀이를 요청합니다.
    3.  분석 완료 시, 현재 페이지에 **모달(Modal) 창**이 뜹니다.
    4.  모달 창에는 분석된 사주의 **요약 내용**이 표시됩니다.
    5.  모달 창 하단에 '상세 페이지로 이동' 버튼이 제공됩니다.
    6.  분석 횟수가 1회 차감됩니다.
    7.  분석 결과는 Supabase DB에 저장됩니다.

### 대시보드 (분석 목록)
* '홈' 페이지에서 접근할 수 있습니다.
* 사용자가 과거에 분석한 사주 내역이 목록(리스트) 형태로 표시됩니다. (예: 이름, 분석 날짜)
* 목록의 각 항목 클릭 시 해당 '분석 상세보기' 페이지로 이동합니다.
* 페이지 내에 '구독 관리' 버튼이 표시됩니다.

### 분석 상세보기
* '대시보드'의 목록 항목 클릭 또는 '새 분석하기' 완료 모달에서 이동할 수 있습니다.
* Gemini가 생성한 상세 사주 풀이 내용 전체가 표시됩니다.
* 분석 내용을 `.md` (Markdown) 파일로 다운로드할 수 있는 버튼을 제공합니다.

### 구독 관리 (토스페이먼츠 연동)
* '홈', '대시보드'에서 접근 가능하며, Free 횟수 소진 시 리디렉션됩니다.
* 현재 구독 상태를 표시합니다:
    * 현재 요금제 (Free / Pro)
    * 구독 시작일 (Pro) / 다음 결제일 (Pro)
    * 구독 금액 (Pro)
    * 남은 사주 분석 기회 (Free/Pro)
* **구독하기 (Pro)**:
    * '홈(인증 전)', '대시보드', '구독 관리' 페이지에 버튼이 제공됩니다.
    * 클릭 시 토스페이먼츠 SDK를 통해 결제수단 등록(빌링키 발급) 절차를 진행합니다.
    * 빌링키 발급 성공 시, 즉시 첫 결제(3,900원)를 시도하고 Pro 요금제로 전환 및 횟수(10회)를 부여합니다.
* **해지하기 (Pro)**:
    * Pro 요금제 취소 시, 다음 결제일까지 구독 상태(Pro 혜택)가 유지됩니다.
    * 다음 결제일 전까지 '해지 취소' 버튼이 활성화되어 구독을 다시 이어갈 수 있습니다.
    * 구독이 최종 해지되는 시점(다음 결제일)에 Supabase에 저장된 빌링키를 삭제합니다. (재구독 시 빌링키 재발급 필요)

## 백엔드 / 스케줄링 (Supabase, Next.js API)
* **월 정기결제 (자동)**:
    * [Supabase Cron] 매일 02:00에 특정 Next.js API 엔드포인트를 트리거합니다.
    * [Next.js API] 호출이 유효한지 검증합니다. (예: Cron Secret Key 확인)
    * [Next.js API] Supabase DB에서 오늘이 다음 결제일인 Pro 구독 건들을 조회합니다.
    * 조회된 구독 건별로 저장된 빌링키를 사용하여 토스페이먼츠 결제 API를 호출합니다.
    * **결제 성공 시**: 해당 유저의 분석 횟수를 10회로 리셋하고, 다음 결제일을 한 달 뒤로 연장합니다.
    * **결제 실패 시**: 즉시 해당 유저의 구독을 해지 상태로 변경하고 빌링키를 삭제합니다. (Pro 혜택 중지)