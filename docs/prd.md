# PRD: AI 사주 풀이 구독 서비스

## 1\. 제품 개요

Clerk(인증), Supabase(DB), 토스페이먼츠(결제), Gemini(AI)를 연동한 월 구독제 AI 사주 풀이 웹 앱.

**핵심 목표**는 (1) 요금제(Free/Pro) 기반의 정확한 기능 접근 가드, (2) 구독 신청/정기결제/해지/횟수제한 등 **상태 기반 비즈니스 룰** 구현, (3) Clerk, 토스페이먼츠, Gemini 등 핵심 외부 API의 안정적인 연동이다. 인증은 **Clerk Auth** 기반으로 운영.

## 2\. Stakeholders

  * **신규 방문자 (Guest)**: 서비스 탐색, 회원가입
  * **무료 사용자 (Free User)**: 가입 직후 상태. 3회 무료 체험.
  * **유료 구독자 (Pro User)**: 월 3,900원 결제. 월 10회 분석, Gemini Pro 모델 접근.

**요금제 정책**: 사용자는 회원가입 시 'Free' 상태로 시작하며, 총 3회의 무료 분석 기회를 가집니다. 'Pro' 요금제 구독 시 'Pro' 상태로 전환되며 월 10회의 기회와 Pro 모델 접근 권한을 얻습니다. 구독 해지 시, 잔여 기간 만료 후 'Free' 상태로 복귀하며 잔여 횟수는 소멸됩니다.

## 3\. 포함 페이지

1.  **홈 (랜딩 페이지)**

      * 서비스 핵심 기능, 가치 제안 설명.
      * 요금제(Free/Pro) 비교 안내.
      * 인증 상태에 따라 '로그인/가입' 또는 '대시보드/새 분석' 버튼 노출.

2.  **인증 (Clerk)**

      * Clerk SDK에서 기본 제공하는 UI/Flow 사용.
      * 이메일/소셜 로그인을 통한 회원가입 및 로그인.
      * **Clerk Webhook 정책**: 사용자 생성(signup) 이벤트 발생 시, Supabase DB에 `users` 및 `subscriptions` 테이블 레코드를 'Free' 기본값으로 생성합니다.

3.  **새 분석하기**

      * 사주 정보 입력 폼 (이름, 생년월일시, 양/음력, 시 '모름' 옵션).
      * (Pro 사용자) Gemini 2.5 Flash / Pro 모델 선택 옵션 노출.
      * 분석 완료 시 요약 결과 모달(Modal) 노출 및 '상세보기' 이동 버튼.
      * **횟수 제한 정책**: Free(총 3회), Pro(월 10회). 횟수 소진 시 '분석하기' 버튼 클릭 시 '구독 관리' 페이지로 리디렉션.

4.  **대시보드 (분석 목록)**

      * 과거 사주 분석 내역을 리스트 형태로 표시 (이름, 분석일자 등).
      * 각 항목 클릭 시 '분석 상세보기' 페이지로 이동.
      * '새 분석하기', '구독 관리' 페이지로 이동하는 CTA 버튼 포함.

5.  **분석 상세보기**

      * Gemini AI가 생성한 상세 분석 결과 텍스트 표시.
      * 분석 내용을 `.md` 파일로 다운로드하는 기능.

6.  **구독 관리**

      * 현재 구독 상태 표시 (요금제, 구독일, 다음 결제일, 남은 분석 횟수).
      * (Free) 'Pro 구독하기' 버튼 → 토스페이먼츠 결제수단 등록(빌링키) 연동.
      * (Pro) '해지하기' 버튼.
      * **해지 정책**: Pro 요금제 해지 신청 시, 다음 결제일까지 구독 상태(Pro 혜택)가 유지됩니다. 이 기간 동안 '해지 취소'가 가능합니다. 결제일 도래 시 자동 해지 및 빌링키가 삭제됩니다.
      * **재구독 정책**: 빌링키 삭제 후 재구독 시, SDK를 통해 결제수단을 다시 등록해야 합니다.

7.  **백엔드 (Next.js API & Supabase Cron)**

      * **정기 결제 정책**:
          * [Supabase Cron] 매일 02:00에 [Next.js API] 엔드포인트 호출.
          * [Next.js API] 오늘이 결제일인 Pro 구독 건 탐색.
          * (성공) 빌링키로 결제 API 호출 → 성공 시 횟수(10회) 리셋, 구독 기간 연장.
          * (실패) 결제 실패 시 즉시 구독 해지(Free 전환), 빌링키 삭제.

## 4\. 사용자 여정 (User Journey)

### 4.1 무료 사용자 (Free User) 여정

1.  홈 → 회원가입/로그인 (Clerk) → 인증 완료 (Free 상태, 3회)
2.  (최초 3회) 홈 또는 대시보드 → '새 분석하기'
3.  정보 입력 (Flash 모델 고정) → '분석하기' → 요약 모달 → '상세보기'
4.  '분석 상세보기' → 내용 확인 / MD 다운로드
5.  (3회 소진 후) '새 분석하기' 시도 → '구독 관리' 페이지로 강제 이동

### 4.2 유료 구독자 (Pro User) 여정

1.  (Free 상태) '구독 관리' 페이지 → 'Pro 구독하기' → 토스페이먼츠(빌링키 발급/첫 결제)
2.  상태 'Pro' 전환 / 횟수 10회 충전 확인
3.  (월 10회) 홈 또는 대시보드 → '새 분석하기'
4.  모델 선택(Pro/Flash) / 정보 입력 → '분석하기' → 상세 보기
5.  (월말) [백엔드 자동 결제] → 성공 시 횟수 리셋 / 구독 연장

### 4.3 구독 해지자 여정

1.  (Pro 상태) '구독 관리' → '해지하기' → 해지 예약 상태 (UI: '해지 취소' 버튼 노출)
2.  (결제일 전) 잔여 횟수 내에서 Pro 서비스 정상 이용
3.  (결제일 02:00) [백엔드] 정기결제 미시도 → 자동 해지 처리 (Free 전환, 빌링키 삭제)

## 5\. IA (Tree)

```
/ (Home - 랜딩)
├─ /sign-in (Clerk 기본 제공)
├─ /sign-up (Clerk 기본 제공)
│
├─ /new-analysis (새 분석하기)
│
├─ /dashboard (대시보드 - 분석 목록)
│  └─ /analysis/[analysisId] (분석 상세보기)
│
└─ /subscription (구독 관리)

(Backend API Routes)
└─ /api
   ├─ /webhooks/clerk (Clerk 유저 생성 동기화)
   ├─ /webhooks/toss (토스페이먼츠 결제 이벤트 수신, 옵션)
   ├─ /payments/subscribe (Pro 구독 신청 및 첫 결제)
   └─ /cron/process-subscriptions (Supabase Cron 정기결제 트리거)
```